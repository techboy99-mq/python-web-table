<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MQ Install Log Viewer</title>
  <link rel="stylesheet" href="css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="css/buttons.dataTables.min.css" />
  <link rel="stylesheet" href="css/rowGroup.dataTables.min.css" />
  <style>
    body { font-family: Arial, sans-serif; padding: 2rem; }
    button { margin-right: 1rem; padding: 0.5rem 1rem; font-size: 1rem; }
    #dateFilter { margin: 1rem 0; display: block; }
    #csv-table { width: 100%; }
  </style>
</head>
<body>
  <h2>MQ Install Log Viewer</h2>
  <a href="charts.html" style="display:inline-block; margin-bottom:1rem;">ðŸ“Š View Charts</a><br>
  <button id="refresh">ðŸ”„ Refresh Table</button>
  <label id="dateFilter">
    Date from <input type="date" id="minDate"> to <input type="date" id="maxDate">
  </label>
  <table id="csv-table" class="display">
    <thead>
      <tr><th>Hostname</th><th>MQ Version</th><th>MQ Install Type</th><th>Date/Time</th><th>Install Status</th><th>Conn Test Status</th></tr>
    </thead>
    <tfoot>
      <tr><th>Hostname</th><th>MQ Version</th><th>MQ Install Type</th><th>Date/Time</th><th>Install Status</th><th>Conn Test Status</th></tr>
    </tfoot>
    <tbody></tbody>
  </table>

  <script src="js/jquery.min.js"></script>
  <script src="js/jquery.dataTables.min.js"></script>
  <script src="js/dataTables.buttons.min.js"></script>
  <script src="js/buttons.html5.min.js"></script>
  <script src="js/jszip.min.js"></script>
  <script src="js/dataTables.rowGroup.min.js"></script>
  <script src="js/papaparse.min.js"></script>

  <script>
    const tableSelector = '#csv-table';

    $.fn.dataTable.ext.search.push(function(settings, data) {
      const min = $('#minDate').val();
      const max = $('#maxDate').val();
      const dt = data[3];  // date string
      if (!dt) return true;
      const d = new Date(dt.replace(' ', 'T'));
      if (min && d < new Date(min)) return false;
      if (max && d > new Date(max)) return false;
      return true;
    });

    $('#minDate, #maxDate').on('change', () => {
      if ($.fn.dataTable.isDataTable(tableSelector)) {
        $(tableSelector).DataTable().draw();
      }
    });

    $('#refresh').on('click', loadTable);

    function loadTable() {
      const url = `data.csv?t=${Date.now()}`;
      console.log('Loading CSV:', url);
      Papa.parse(url, {
        download: true,
        header: false,
        skipEmptyLines: true,
        complete: results => {
          console.log('Parsed data:', results.data.slice(0, 5), '... total rows:', results.data.length);
          renderTable(results.data);
        },
        error: err => console.error('PapaParse error:', err)
      });
    }

    function renderTable(data) {
      if ($.fn.dataTable.isDataTable(tableSelector)) {
        $(tableSelector).DataTable().clear().destroy();
      }
      const table = $(tableSelector).DataTable({
        data,
        columns: [
          { title: 'Hostname', data: 0 },
          { title: 'MQ Version', data: 1 },
          { title: 'MQ Install Type', data: 2 },
          { title: 'Date/Time', data: 3 },
          { title: 'Install Status', data: 4 },
          { title: 'Conn Test Status', data: 5 }
        ],
        dom: 'Bfrtip',
        buttons: [
          { extend: 'csvHtml5', text: 'Export CSV' },
          { extend: 'excelHtml5', text: 'Export Excel' }
        ],
        rowGroup: { dataSrc: 2 },
        pageLength: 10,
        initComplete() { setupColumnFilters(this); }
      });
    }

    function setupColumnFilters(dtApi) {
      dtApi.columns().every(function() {
        const col = this;
        const footer = $(col.footer()).empty();
        const select = $('<select><option value="">All</option></select>').appendTo(footer)
        .on('change', () => {
          const val = $.fn.dataTable.util.escapeRegex(select.val());
          col.search(val ? '^'+val+'$' : '', true, false).draw();
        });
        col.data().unique().sort().each(d => {
          if (d) select.append(new Option(d, d));
        });
      });
    }

    $(document).ready(loadTable);
  </script>
</body>
</html>
