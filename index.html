<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MQ Install Log Viewer</title>
  <!-- Local CSS files -->
  <link rel="stylesheet" href="css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="css/buttons.dataTables.min.css" />
  <link rel="stylesheet" href="css/rowGroup.dataTables.min.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2rem;
    }
    button {
      margin-right: 1rem;
      padding: 0.5rem 1rem;
      font-size: 1rem;
    }
    #dateFilter {
      margin: 1rem 0;
    }
    #csv-table {
      width: 100%;
    }
  </style>
</head>
<body>
  <h2>MQ Install Log Viewer</h2>

  <div>
    <a href="charts.html" style="margin-bottom: 1rem; display: inline-block;">ðŸ“Š View Charts</a><br /><br />
    <button onclick="loadTable()">ðŸ”„ Refresh Table</button>
    <label id="dateFilter">
      Date from <input type="date" id="minDate" /> to <input type="date" id="maxDate" />
    </label>
  </div>

  <table id="csv-table" class="display">
    <thead>
      <tr>
        <th>Hostname</th>
        <th>MQ Version</th>
        <th>MQ Install Type</th>
        <th>Date/Time</th>
        <th>Install Status</th>
        <th>Conn Test Status</th>
      </tr>
    </thead>
    <tfoot>
      <tr>
        <th>Hostname</th>
        <th>MQ Version</th>
        <th>MQ Install Type</th>
        <th>Date/Time</th>
        <th>Install Status</th>
        <th>Conn Test Status</th>
      </tr>
    </tfoot>
    <tbody></tbody>
  </table>

  <!-- Local JS files -->
  <script src="js/jquery.min.js"></script>
  <script src="js/jquery.dataTables.min.js"></script>
  <script src="js/dataTables.buttons.min.js"></script>
  <script src="js/buttons.html5.min.js"></script>
  <script src="js/jszip.min.js"></script>
  <script src="js/rowGroup.dataTables.min.js"></script>
  <script src="js/papaparse.min.js"></script>

  <script>
    // Extend DataTables with date range filtering
    $.fn.dataTable.ext.search.push(function (settings, data) {
      const min = $('#minDate').val();
      const max = $('#maxDate').val();
      const dateTime = data[3]; // Date/Time column
      if (!min && !max) return true;
      const d = new Date(dateTime.replace(' ', 'T'));
      if ((min && d < new Date(min)) || (max && d > new Date(max))) return false;
      return true;
    });

    $('#minDate, #maxDate').on('change', () => {
      $('#csv-table').DataTable().draw();
    });

    function loadTable() {
      const csvUrl = `data.csv?t=${Date.now()}`; // bust cache
      Papa.parse(csvUrl, {
        download: true,
        header: false,
        skipEmptyLines: true,
        complete: (results) => {
          const data = results.data;
          if ($.fn.dataTable.isDataTable('#csv-table')) {
            $('#csv-table').DataTable().clear().destroy();
          }

          const table = $('#csv-table').DataTable({
            data,
            columns: [
              { title: 'Hostname', data: 0 },
              { title: 'MQ Version', data: 1 },
              { title: 'MQ Install Type', data: 2 },
              { title: 'Date/Time', data: 3 },
              { title: 'Install Status', data: 4 },
              { title: 'Conn Test Status', data: 5 }
            ],
            dom: 'Bfrtip',
            buttons: [
              { extend: 'csvHtml5', text: 'Export CSV' },
              { extend: 'excelHtml5', text: 'Export Excel' }
            ],
            rowGroup: {
              dataSrc: 2
            },
            pageLength: 10,
            initComplete: setupColumnFilters
          });
        }
      });
    }

    function setupColumnFilters() {
      this.api().columns().every(function () {
        const colIdx = this.index();
        const select = $('<select><option value="">All</option></select>')
          .appendTo($(this.footer()).empty())
          .on('change', function () {
            const val = $.fn.dataTable.util.escapeRegex($(this).val());
            this.api().column(colIdx).search(val ? '^' + val + '$' : '', true, false).draw();
          }.bind(this));

        this.data().unique().sort().each((d) => {
          if (d) select.append(`<option value="${d}">${d}</option>`);
        });
      });
    }

    window.onload = loadTable;
  </script>
</body>
</html>
