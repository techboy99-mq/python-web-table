<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MQ Install Charts</title>
  <link rel="stylesheet" href="css/jquery.dataTables.min.css" />
  <style>
    body { font-family: Arial, sans-serif; padding: 2rem; }
    a.back-link { display: inline-block; margin-bottom: 1rem; font-size: 1.1rem; text-decoration: none; }
    a.back-link:hover { text-decoration: underline; }
    .chart-container { max-width: 600px; margin-bottom: 3rem; }
    .filter-group { margin-bottom: 1rem; }
    label { margin-right: 1rem; }
    select, input[type="date"] { padding: 0.3rem 0.5rem; }
  </style>
</head>
<body>
  <a href="index.html" class="back-link">‚Üê Back to Table</a>

  <h2>MQ Install Success vs Failures</h2>
  <div class="chart-container">
    <canvas id="pieChart" width="400" height="400"></canvas>
  </div>

  <h2>Install Status by Type (Filtered)</h2>
  
  <div class="filter-group">
    <label for="filterStartDate">Start Date:</label>
    <input type="date" id="filterStartDate" />
    <label for="filterEndDate">End Date:</label>
    <input type="date" id="filterEndDate" />
    
    <label for="filterInstallStatus">Install Status:</label>
    <select id="filterInstallStatus">
      <option value="">All</option>
      <option value="success">Success</option>
      <option value="failed">Failed</option>
    </select>

    <label for="filterInstallType">Install Type:</label>
    <select id="filterInstallType">
      <option value="">All</option>
      <option value="client">Client</option>
      <option value="server">Server</option>
    </select>

    <button id="applyFilters">Apply Filters</button>
  </div>

  <div class="chart-container">
    <canvas id="barChart" width="600" height="400"></canvas>
  </div>

  <script src="js/jquery.min.js"></script>
  <script src="js/chart.min.js"></script>
  <script src="js/chartjs-plugin-datalabels.min.js"></script>
  <script src="js/papaparse.min.js"></script>

  <script>
    let rawData = [];
    let pieChart, barChart;

    // Load and parse CSV data
    function loadData() {
      Papa.parse('data.csv', {
        download: true,
        header: false,
        skipEmptyLines: true,
        complete: function(results) {
          rawData = results.data;
          drawPieChart();
          drawBarChart();
        }
      });
    }

    // Utility: Parse date string 'YYYY-MM-DD' into Date object
    function parseDate(str) {
      if (!str) return null;
      const parts = str.split('-');
      return new Date(parts[0], parts[1] - 1, parts[2]);
    }

    // Draw Pie Chart: Success vs Fail count with count & %
    function drawPieChart() {
      const counts = { success: 0, failed: 0 };
      rawData.forEach(row => {
        const status = row[5].toLowerCase();
        if (status === 'success' || status === 'failed') counts[status]++;
      });

      const total = counts.success + counts.failed;
      const data = [counts.success, counts.failed];

      const ctx = document.getElementById('pieChart').getContext('2d');
      if (pieChart) pieChart.destroy();

      pieChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Success', 'Failed'],
          datasets: [{
            data,
            backgroundColor: ['#4caf50', '#f44336'],
          }]
        },
        options: {
          plugins: {
            datalabels: {
              formatter: (value, ctx) => {
                const label = ctx.chart.data.labels[ctx.dataIndex];
                const percent = (value / total * 100).toFixed(1);
                return `${label}\n${value} (${percent}%)`;
              },
              color: '#fff',
              font: { weight: 'bold', size: 14 }
            },
            legend: {
              position: 'bottom'
            },
            tooltip: {
              callbacks: {
                label: ctx => {
                  const val = ctx.raw;
                  const pct = (val / total * 100).toFixed(2);
                  return `${ctx.label}: ${val} (${pct}%)`;
                }
              }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    }

    // Draw Bar Chart: Install Status by Install Type with filters
    function drawBarChart() {
      const startDate = parseDate(document.getElementById('filterStartDate').value);
      const endDate = parseDate(document.getElementById('filterEndDate').value);
      const installStatusFilter = document.getElementById('filterInstallStatus').value.toLowerCase();
      const installTypeFilter = document.getElementById('filterInstallType').value.toLowerCase();

      // Count structure: {client: {success: x, failed: y}, server: {...}}
      const counts = { client: { success: 0, failed: 0 }, server: { success: 0, failed: 0 } };

      rawData.forEach(row => {
        const dateStr = row[3];
        const dateObj = parseDate(dateStr);
        if (!dateObj) return; // skip invalid date

        // Date range filter
        if (startDate && dateObj < startDate) return;
        if (endDate && dateObj > endDate) return;

        const status = row[5].toLowerCase();
        const type = row[2].toLowerCase();

        // Install status filter
        if (installStatusFilter && status !== installStatusFilter) return;

        // Install type filter
        if (installTypeFilter && type !== installTypeFilter) return;

        if (counts[type] && counts[type][status] !== undefined) {
          counts[type][status]++;
        }
      });

      const ctx = document.getElementById('barChart').getContext('2d');
      if (barChart) barChart.destroy();

      barChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Client', 'Server'],
          datasets: [
            {
              label: 'Success',
              backgroundColor: '#4caf50',
              data: [counts.client.success, counts.server.success]
            },
            {
              label: 'Failed',
              backgroundColor: '#f44336',
              data: [counts.client.failed, counts.server.failed]
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            tooltip: { mode: 'index', intersect: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              precision: 0,
              title: { display: true, text: 'Count' }
            },
            x: {
              title: { display: true, text: 'Install Type' }
            }
          }
        }
      });
    }

    document.getElementById('applyFilters').addEventListener('click', () => {
      drawBarChart();
    });

    // Load data on page load
    window.onload = loadData;
  </script>
</body>
</html>
