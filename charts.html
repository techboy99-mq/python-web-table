<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MQ Install Charts</title>
  <link rel="stylesheet" href="css/jquery.dataTables.min.css" />
  <style>
    body { font-family: Arial, sans-serif; padding: 2rem; }
    #filters { margin-bottom: 1rem; }
    #pieChartContainer {
      max-width: 350px;
      max-height: 350px;
      margin-bottom: 2rem;
    }
    #pieChart {
      width: 100% !important;
      height: 100% !important;
    }
    #barChartContainer {
      max-width: 700px;
      margin-bottom: 2rem;
    }
    canvas {
      display: block;
      max-width: 100%;
    }
    label {
      margin-right: 1rem;
    }
  </style>
</head>
<body>
  <h2>MQ Install Charts</h2>
  <div id="filters">
    <label>Date from <input type="date" id="minDate" /></label>
    <label>to <input type="date" id="maxDate" /></label>
    <button id="applyFilters">Apply Filters</button>
  </div>

  <div id="pieChartContainer">
    <canvas id="pieChart"></canvas>
  </div>

  <div id="barChartContainer">
    <canvas id="barChart"></canvas>
  </div>

  <!-- JS dependencies -->
  <script src="js/jquery.min.js"></script>
  <script src="js/papaparse.min.js"></script>
  <script src="js/chart.min.js"></script>
  <script src="js/chartjs-plugin-datalabels.min.js"></script>

  <script>
    let rawData = [];

    // Parse CSV and store data
    function loadData(callback) {
      Papa.parse('data.csv', {
        download: true,
        header: false,
        skipEmptyLines: true,
        complete: function(results) {
          rawData = results.data.map(row => ({
            hostname: row[0],
            mq_version: row[1],
            mq_install_type: row[2],
            date: row[3],       // YYYY-MM-DD
            time: row[4],       // HH:MM
            install_status: row[5].toLowerCase(),
            conn_test_status: row[6].toLowerCase()
          }));
          callback();
        }
      });
    }

    // Filter data by date range
    function filterByDate(data, minDate, maxDate) {
      if (!minDate && !maxDate) return data;
      return data.filter(d => {
        if (!d.date) return false;
        const currentDate = new Date(d.date);
        if (minDate && currentDate < new Date(minDate)) return false;
        if (maxDate && currentDate > new Date(maxDate)) return false;
        return true;
      });
    }

    let pieChartInstance, barChartInstance;

    function createPieChart(data) {
      const counts = { success: 0, failed: 0 };
      data.forEach(row => {
        if (row.install_status === 'success') counts.success++;
        else if (row.install_status === 'failed') counts.failed++;
      });
      const total = counts.success + counts.failed;

      const pieData = {
        labels: [
          `Success (${counts.success})`,
          `Failed (${counts.failed})`
        ],
        datasets: [{
          data: [counts.success, counts.failed],
          backgroundColor: ['#28a745', '#dc3545']
        }]
      };

      const ctx = document.getElementById('pieChart').getContext('2d');
      if (pieChartInstance) pieChartInstance.destroy();
      pieChartInstance = new Chart(ctx, {
        type: 'pie',
        data: pieData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            },
            datalabels: {
              formatter: (value, ctx) => {
                let percent = (value / total * 100).toFixed(1);
                return `${value} (${percent}%)`;
              },
              color: '#fff',
              font: {
                weight: 'bold',
                size: 14
              }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    }

    function createBarChart(data) {
      // Count success/fail by install type
      const stats = {};
      data.forEach(row => {
        if (!row.mq_install_type || !row.install_status) return;
        const type = row.mq_install_type;
        const status = row.install_status;
        if (!stats[type]) stats[type] = { success: 0, failed: 0 };
        if (status === 'success') stats[type].success++;
        else if (status === 'failed') stats[type].failed++;
      });

      const labels = Object.keys(stats);
      const successData = labels.map(l => stats[l].success);
      const failedData = labels.map(l => stats[l].failed);

      const ctx = document.getElementById('barChart').getContext('2d');
      if (barChartInstance) barChartInstance.destroy();

      barChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Success',
              backgroundColor: '#28a745',
              data: successData
            },
            {
              label: 'Failed',
              backgroundColor: '#dc3545',
              data: failedData
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true, precision: 0 }
          },
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    function applyFiltersAndDraw() {
      const minDate = document.getElementById('minDate').value;
      const maxDate = document.getElementById('maxDate').value;
      const filteredData = filterByDate(rawData, minDate, maxDate);
      createPieChart(filteredData);
      createBarChart(filteredData);
    }

    document.getElementById('applyFilters').addEventListener('click', applyFiltersAndDraw);

    // Initial load
    loadData(applyFiltersAndDraw);
  </script>
</body>
</html>
